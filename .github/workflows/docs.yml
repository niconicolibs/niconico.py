name: Docs

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  generate_pdoc:
    name: generating pdoc
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      
      # set up python
      - name: Setting up python.
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
        
      # install poetry
      #- name: Install Poetry
      #  run: |
      #    curl -sSL https://install.python-poetry.org/ | python
      
      #- name: Add path for Poetry
      #  run: echo "$HOME/.poetry/bin" >> $GITHUB_PATH
      
      # install dependencies
      #- name: Install Dependencies
      #  run: poetry install --no-interaction --no-dev
      
      - name: Install Dependencies
        run: pip install requests beautifulsoup4 pdoc3

      # pdocでドキュメントを生成
      - name: Pdoc
        run: pdoc --html -o docs --force niconico
      
      # 差分をgitにpushする
      # ref: https://zenn.dev/lollipop_onl/articles/eoz-gha-push-diffs
      - name: Push new docs
        run: |
          git remote set-url origin https://github-actions:${{secrets.GITHUB_TOKEN}}@github.com/${{GITHUB_REPOSITORY}}
          git config --global user.name "${{GITHUB_ACTOR}}"
          git config --global user.email "${{GITHUB_ACTOR}}@users.noreply.github.com"
          if (git diff --shortstat | grep '[0-9]'); then \
            git add .; \
            git commit -m "Generating docs via GitHub Actions"; \
            git push origin HEAD:${{GITHUB_REF}}; \
          fi